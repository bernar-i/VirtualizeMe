#!/usr/bin/env ruby

require 'rconfig'

module SkyCloud
  class IaasManager
    attr_reader :oVim

    def initilize
      @oVim = nil
    end

    def cloneVm aParams
      #dcname = "ha-datacenter"
      oRbVmomiManager = RbVmomiManager.new
      oVim = oRbVmomiManager.connect

      oVm = oVim.serviceInstance.find_datacenter.find_vm(aParams[:template])
      relocateSpec = RbVmomi::VIM.VirtualMachineRelocateSpec
      spec = RbVmomi::VIM.VirtualMachineCloneSpec(:location => relocateSpec, :powerOn => false, :template => false)

      oVm.CloneVM_Task(:folder => oVm.parent, :name => aParams[:name], :spec => spec).wait_for_completion

      oRbVmomiManager.close
    end

  end
end
